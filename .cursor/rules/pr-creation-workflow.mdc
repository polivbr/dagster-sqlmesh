---
description: PR Creation Workflow - Local validation before GitHub PR creation
---

# PR Creation Workflow

This rule defines the complete process for creating a Pull Request, ensuring all CI/CD checks pass locally before submission.

## ğŸ“‹ Pre-PR Checklist

Before creating a PR using `gh pr create`, you MUST run the following commands locally to mirror the CI/CD pipeline:

### 1. ğŸ”§ Install Dependencies

```bash
# Ensure dependencies are up to date
uv sync --group dev
uv pip install -e .
```

### 2. ğŸ“¦ Version Consistency Check

```bash
# Check version consistency between pyproject.toml and __init__.py
PYPROJECT_VERSION=$(grep 'version = ' pyproject.toml | cut -d'"' -f2)
INIT_VERSION=$(grep '__version__ = ' src/dg_sqlmesh/__init__.py | cut -d'"' -f2)
echo "pyproject.toml version: $PYPROJECT_VERSION"
echo "__init__.py version: $INIT_VERSION"
if [ "$PYPROJECT_VERSION" != "$INIT_VERSION" ]; then
  echo "âŒ Version mismatch between pyproject.toml and __init__.py"
  exit 1
fi
echo "âœ… Versions are consistent"
```

### 3. ğŸ¨ Code Quality Checks (MANDATORY)

```bash
# Ruff linting - MUST pass before PR
echo "ğŸ” Running ruff linting..."
uv run ruff check --ignore=F401,F811,E402 src/dg_sqlmesh/ tests/

# Ruff formatting check - MUST pass before PR
echo "ğŸ¨ Running ruff formatting check..."
uv run ruff format --check src/dg_sqlmesh/ tests/

# If formatting issues, auto-fix them:
# uv run ruff format src/dg_sqlmesh/ tests/
```

### 4. ğŸ¦… Dead Code Detection

```bash
# Vulture dead code detection (informational)
echo "ğŸ¦… Running vulture to detect dead code..."
uv run vulture src/dg_sqlmesh/ --min-confidence 80 || true
```

### 5. ğŸ“Š Load Test Data

```bash
# Load test data (required for tests)
echo "ğŸ“Š Loading test data..."
uv run --group dev python tests/load_jaffle_data.py
```

### 6. ğŸ§ª Run Complete Test Suite (MANDATORY)

```bash
# Run tests with coverage - MUST pass before PR
echo "ğŸ§ª Running tests with coverage..."
uv run coverage run -m pytest tests/ -v --tb=short
uv run coverage report --show-missing
```

### 7. ğŸ”¨ Build Verification

```bash
# Clean and build package
rm -rf dist/ build/ src/*.egg-info/
echo "ğŸ”¨ Building package..."
uv build
echo "ğŸ“¦ Build artifacts:"
ls -la dist/

# Verify build contents
echo "ğŸ” Verifying wheel contents..."
uv run python -m zipfile -l dist/*.whl
```

### 8. ğŸ”’ Security Checks (for dependency changes)

```bash
# Only run if pyproject.toml or uv.lock changed
echo "ğŸ”’ Running security audit..."
uv run pip-audit --desc || true
uv run safety check || true
```

## ğŸš€ PR Creation Process

### Complete Pre-PR Script

Create this script and run it before every PR:

```bash
#!/bin/bash
# File: scripts/pre-pr-check.sh

set -e  # Exit on any error

echo "ğŸ”„ Starting pre-PR validation..."

# 1. Dependencies
echo "ğŸ“¦ Installing dependencies..."
uv sync --group dev
uv pip install -e .

# 2. Version consistency
echo "ğŸ” Checking version consistency..."
PYPROJECT_VERSION=$(grep 'version = ' pyproject.toml | cut -d'"' -f2)
INIT_VERSION=$(grep '__version__ = ' src/dg_sqlmesh/__init__.py | cut -d'"' -f2)
if [ "$PYPROJECT_VERSION" != "$INIT_VERSION" ]; then
  echo "âŒ Version mismatch between pyproject.toml and __init__.py"
  exit 1
fi
echo "âœ… Versions are consistent"

# 3. Code quality (CRITICAL)
echo "ğŸ¨ Running ruff checks..."
uv run ruff check --ignore=F401,F811,E402 src/dg_sqlmesh/ tests/
uv run ruff format --check src/dg_sqlmesh/ tests/

# 4. Dead code detection
echo "ğŸ¦… Running vulture..."
uv run vulture src/dg_sqlmesh/ --min-confidence 60 || true

# 5. Load test data
echo "ğŸ“Š Loading test data..."
uv run --group dev python tests/load_jaffle_data.py

# 6. Run tests (CRITICAL)
echo "ğŸ§ª Running test suite..."
uv run coverage run -m pytest tests/ -v --tb=short
uv run coverage report --show-missing

# 7. Build verification
echo "ğŸ”¨ Building package..."
rm -rf dist/ build/ src/*.egg-info/
uv build
uv run python -m zipfile -l dist/*.whl

echo "âœ… All pre-PR checks passed! Ready to create PR."
```

### GitHub PR Creation

```bash
# After all checks pass, create the PR
gh pr create \
  --title "âœ¨ Your descriptive title" \
  --body "## Overview

Detailed description of changes...

## Testing
- âœ… All ruff checks pass
- âœ… All tests pass (162/162)
- âœ… Package builds successfully
- âœ… No breaking changes

## Related
- Fixes #issue_number
- Related to #other_issue" \
  --draft  # Start as draft, mark ready when truly ready
```

## âš ï¸ Critical Rules

1. **NEVER** create a PR without running local validation first
2. **ALL** ruff checks MUST pass (no exceptions for --ignore)
3. **ALL** tests MUST pass (162/162)
4. **ALWAYS** run the complete pipeline locally
5. **USE** meaningful commit messages following conventional commits
6. **START** PRs as drafts, mark ready only after review

## ğŸ”§ Quick Commands Reference

```bash
# Minimal pre-PR validation (fastest)
uv run ruff check src/dg_sqlmesh/ tests/ && \
uv run ruff format --check src/dg_sqlmesh/ tests/ && \
uv run pytest tests/ -v

# Complete pre-PR validation (recommended)
./scripts/pre-pr-check.sh

# Create PR after validation
gh pr create --title "feat: your change" --body "Description" --draft
```

## ğŸ“š Related Files

- CI/CD Pipeline: [.github/workflows/test.yml](mdc:.github/workflows/test.yml)
- Security Pipeline: [.github/workflows/security.yml](mdc:.github/workflows/security.yml)
- Project Config: [pyproject.toml](mdc:pyproject.toml)
- Test Commands: [.cursor/rules/test-commands.mdc](mdc:.cursor/rules/test-commands.mdc)

---

**Remember: The goal is to catch issues locally before they reach CI/CD, saving time and ensuring code quality! ğŸ¯**
